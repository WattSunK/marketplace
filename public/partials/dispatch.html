<section class="card">
  <div class="card-header" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:#fff;border-bottom:1px solid #f0f0f0">
    <h2 style="margin:0;font-size:18px;font-weight:600">Dispatch</h2>
    <div style="margin-left:auto">
      <input id="dispatchSearch" placeholder="Search orders…" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;width:240px">
    </div>
  </div>
  <div class="card-body" style="padding:0 12px 12px">
    <div class="table-responsive">
      <table class="table" id="dispatchTable" style="width:100%">
        <thead>
          <tr>
            <th style="white-space:nowrap">Order ID</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Driver</th>
            <th>Created</th>
            <th style="width:90px"></th> <!-- Action -->
          </tr>
        </thead>
        <tbody id="dispatchTbody">
          <tr><td colspan="6" style="text-align:center;color:#6b7280">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Items-style modal (simple, no frameworks) -->
<div id="dispatchViewModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000;">
  <div class="modal-dialog" style="max-width:640px;margin:6% auto;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden">
    <div class="modal-content">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #f0f0f0">
        <h3 style="margin:0;font-size:18px;font-weight:600" id="dv-title">Order</h3>
        <button type="button" class="close" aria-label="Close" style="font-size:22px;line-height:1;border:none;background:transparent;cursor:pointer">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px" id="dv-body">
        <!-- Filled by JS -->
      </div>
      <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid #f0f0f0">
        <button type="button" class="btn" data-close style="padding:8px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const TBODY  = document.getElementById('dispatchTbody');
  const SEARCH = document.getElementById('dispatchSearch');
  const MODAL  = document.getElementById('dispatchViewModal');
  const TITLE  = document.getElementById('dv-title');
  const BODY   = document.getElementById('dv-body');

  if (!window.WattSunAdminData) {
    TBODY.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444">Adapter missing.</td></tr>';
    return;
  }
  const Data = window.WattSunAdminData;

  let rows = []; // normalized orders from adapter

  function driverName(o) {
    const r = o.raw || {};
    return (
      r?.driver?.name ||
      r?.driverName ||
      r?.driver_fullname ||
      (r?.driver_id ? ('#' + r.driver_id) : null) ||
      'Unassigned'
    );
  }

  function render(list) {
    if (!Array.isArray(list) || list.length === 0) {
      TBODY.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280">No orders.</td></tr>';
      return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(o => {
      const tr = document.createElement('tr');
      const created = o.createdAt ? new Date(o.createdAt).toLocaleString() : '—';
      tr.innerHTML = `
        <td style="white-space:nowrap">${o.id || ''}</td>
        <td>${o.fullName || '—'}<br><small>${o.phone || ''} ${o.email || ''}</small></td>
        <td>${o.status || 'Pending'}</td>
        <td>${driverName(o)}</td>
        <td>${created}</td>
        <td><button class="btn btn-sm btn-outline" data-view-id="${o.id || ''}" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer">View</button></td>
      `;
      frag.appendChild(tr);
    });
    TBODY.innerHTML = '';
    TBODY.appendChild(frag);
  }

  function onSearch() {
    const q = (SEARCH.value || '').trim().toLowerCase();
    if (!q) return render(rows);
    const filtered = rows.filter(o => {
      const hay = [
        o.id, o.fullName, o.email, o.phone, o.status, driverName(o)
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(q);
    });
    render(filtered);
  }

  function currencyKES(cents) {
    if (typeof cents !== 'number') return '—';
    return 'KSh ' + (cents/100).toLocaleString();
  }

  function showModal(o) {
    // Title
    TITTLE = TITTLE || document.getElementById('dv-title'); // defensive if hot-replaced
    if (TITTLE) TITTLE.textContent = `Order ${o.id || o.orderNumber || ''}`;

    // Body (simple, items-style layout)
    const total = (typeof o.totalCents === 'number') ? currencyKES(o.totalCents) : (o.total ? ('KSh ' + o.total.toLocaleString()) : '—');
    const drv   = driverName(o);
    const parts = [];
    (o.items || o.cart || []).forEach(it => {
      const qty = (it.quantity != null && it.quantity !== '') ? ` × ${it.quantity}` : '';
      parts.push(`<li>${(it.name || '').replace(/</g,'&lt;')}${qty}</li>`);
    });
    const itemsHTML = parts.length ? `<ul style="margin:6px 0 0 18px">${parts.join('')}</ul>` : '<em>No line items</em>';

    BODY.innerHTML = `
      <div style="display:grid;grid-template-columns:160px 1fr;row-gap:8px;column-gap:12px">
        <div style="color:#6b7280">Customer</div><div>${o.fullName || '—'}<br><small>${o.phone || ''} ${o.email || ''}</small></div>
        <div style="color:#6b7280">Status</div><div>${o.status || 'Pending'}</div>
        <div style="color:#6b7280">Driver</div><div>${drv}</div>
        <div style="color:#6b7280">Total</div><div>${total}</div>
        <div style="color:#6b7280">Created</div><div>${o.createdAt ? new Date(o.createdAt).toLocaleString() : '—'}</div>
        <div style="color:#6b7280">Items</div><div>${itemsHTML}</div>
        <div style="color:#6b7280">Notes</div><div>${(o.notes || '').toString().replace(/</g,'&lt;') || '—'}</div>
      </div>
    `;

    // Open/close (items-style close behaviors)
    MODAL.style.display = 'block';
  }

  function closeModal() {
    MODAL.style.display = 'none';
  }

  // Close hooks (X and footer button)
  (MODAL.querySelector('.close') || {}).onclick = closeModal;
  (MODAL.querySelector('[data-close]') || {}).onclick = closeModal;
  MODAL.addEventListener('click', (e) => { if (e.target === MODAL) closeModal(); });

  TBODY.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-view-id]');
    if (!btn) return;
    const id = btn.getAttribute('data-view-id');
    const o  = rows.find(r => String(r.id) === String(id));
    if (o) showModal(o);
  });

  async function load() {
    try {
      const { orders } = await Data.orders.get({ page: 1, per: 10000 });
      rows = Array.isArray(orders) ? orders : [];
      render(rows);
    } catch (e) {
      console.error('[Dispatch] load failed:', e);
      TBODY.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444">Failed to load.</td></tr>';
    }
  }

  SEARCH?.addEventListener('input', onSearch);
  load();
})();
</script>
