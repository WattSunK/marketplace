<section class="card">
  <div class="card-header" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:#fff;border-bottom:1px solid #f0f0f0">
    <h2 style="margin:0;font-size:18px;font-weight:600">Dispatch</h2>
    <div style="margin-left:auto">
      <input id="dispatchSearch" placeholder="Search orders…" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;width:240px">
    </div>
  </div>
  <div class="card-body" style="padding:0 12px 12px">
    <div class="table-responsive">
      <table class="table" id="dispatchTable" style="width:100%">
        <thead>
          <tr>
            <th style="white-space:nowrap">Order ID</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Driver</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="dispatchTbody">
          <tr><td colspan="5" style="text-align:center;color:#6b7280">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
(function(){
  const TBODY = document.getElementById('dispatchTbody');
  const SEARCH = document.getElementById('dispatchSearch');
  let rows = [];

  function driverName(o) {
    return (
      o?.driver?.name ||
      o?.driverName ||
      o?.driver_fullname ||
      (o?.driver_id ? ('#' + o.driver_id) : null) ||
      'Unassigned'
    );
  }

  function render(list) {
    if (!Array.isArray(list) || !list.length) {
      TBODY.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280">No orders.</td></tr>';
      return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(o => {
      const tr = document.createElement('tr');
      const id = String(o.orderNumber || o.id || '');
      const customer = o.fullName || o.name || '—';
      const created = o.createdAt ? new Date(o.createdAt).toLocaleString() : '—';
      tr.innerHTML = `
        <td style="white-space:nowrap">${id}</td>
        <td>${customer}<br><small>${o.phone || ''} ${o.email || ''}</small></td>
        <td>${o.status || o.orderType || 'Pending'}</td>
        <td>${driverName(o)}</td>
        <td>${created}</td>
      `;
      frag.appendChild(tr);
    });
    TBODY.innerHTML = '';
    TBODY.appendChild(frag);
  }

  function normalize(data) {
    // Accept both {orders:[...]} and [...]
    return Array.isArray(data?.orders) ? data.orders : (Array.isArray(data) ? data : []);
  }

  async function fetchJson(url) {
    const r = await fetch(url);
    if (!r.ok) {
      const err = new Error('HTTP ' + r.status);
      err.status = r.status;
      throw err;
    }
    return r.json();
  }

  async function load() {
    TBODY.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280">Loading…</td></tr>';
    const ts = Date.now();

    // 1) Try admin endpoint
    try {
      const d = await fetchJson(`/api/admin/orders?page=1&per=100&_=${ts}`);
      rows = normalize(d);
      render(rows);
      return;
    } catch (e) {
      if (e.status !== 404) {
        // non-404 failure: show error
        TBODY.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444">Failed to load.</td></tr>';
        return;
      }
      // 2) Fallback to customer endpoint if admin path is not available
      try {
        const d2 = await fetchJson(`/api/orders?page=1&per=100&_=${ts}`);
        rows = normalize(d2);
        render(rows);
        return;
      } catch {
        TBODY.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444">Failed to load.</td></tr>';
      }
    }
  }

  function onSearch() {
    const q = (SEARCH.value || '').trim().toLowerCase();
    if (!q) return render(rows);
    const filtered = rows.filter(o => {
      const hay = [
        o.orderNumber, o.id, o.fullName, o.name, o.phone, o.email,
        o.status, driverName(o)
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(q);
    });
    render(filtered);
  }

  SEARCH?.addEventListener('input', onSearch);
  load();
})();
</script>
