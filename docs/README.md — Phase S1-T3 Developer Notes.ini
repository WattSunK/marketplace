README.md — Phase S1-T3 Developer Notes
# Tenant–Landlord Marketplace — Phase S1-T3 Developer Notes
_Date: 09 Oct 2025_

---

## 🎯 Objective
Introduce the **Lease** and **Payment** integration layer that links tenants, units, and landlords.  
Adds `/api/leases` and `/api/payments` endpoints, plus SQL migrations for the new tables.

---

## 🧩 Repository Additions


routes/
├── leases.js
└── payments.js
scripts/sql/
└── 2025-10-09_create_leases_payments.sql
docs/
└── S1-T3_Test_Plan.md
tests/
└── api_leases_payments.sh


---

## ⚙️ Installation & Migration

```bash
# Ensure DB is accessible
sqlite3 data/dev/marketplace.dev.db ".tables"

# Apply migration
sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql


Tables expected:

leases
payments
lease_balances (VIEW)

🚀 API Mount Check

Confirm these lines exist in server.js:

import leasesRouter from "./routes/leases.js";
import paymentsRouter from "./routes/payments.js";

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart:

sudo node server.js

🧪 Smoke Verification
bash tests/api_leases_payments.sh


Expected:

/api/leases → { success:true, data:[...] }

/api/payments → { success:true, data:[...] }

/api/health → includes leases and payments counts.

🧠 Developer Tips
Area	Note
Pagination	Controlled by ?page= and ?per= in /api/leases.
Role-based Access	requireAnyRole(["admin","landlord","tenant"]) used in both routes.
Balance Calculation	Derived from SQL view lease_balances.
Testing	Use separate cookies (admin.jar, landlord.jar, tenant.jar) for role-scoped curl tests.
✅ Definition of Done
Task	Status
Lease + Payment tables migrated	☐
/api/leases and /api/payments CRUD implemented	☐
Role guards enforced	☐
/api/health includes counts	☐
All curl tests pass	☐
Tag commit → S1-T3-complete	☐

---

### 🧾 Verification Plan for S1-T3

Once this README and starter pack are deployed:

1. **Run Migration**
   ```bash
   sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql
   sqlite3 data/dev/marketplace.dev.db ".tables"


→ confirm leases, payments, and lease_balances.

Mount Routes
In server.js add:

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart Server

sudo node server.js


Smoke Test

bash tests/api_leases_payments.sh


Functional Test

POST /api/leases to create lease

POST /api/payments to add payment

GET /api/leases/:id → should show embedded payments & balance

GET /api/health → should show new entity counts

Tag after success

git add .
git commit -m "S1-T3: Lease & Payment APIs verified"
git tag -a S1-T3-complete -m "Lease & Payment Integration verified"
git push origin main --tags
# Tenant–Landlord Marketplace — Phase S1-T3 Developer Notes
_Date: 07 Oct 2025 (Finalized)_

---

## 🎯 Objective
Implement and verify the **Lease & Payment integration layer** that links tenants, units, and landlords.  
Adds `/api/leases` and `/api/payments` endpoints backed by the relational schema with complete role-based access and health monitoring.

---

## 🧩 Repository Additions

routes/
├── leases.js
├── payments.js
middleware/
├── requireRole.js # reads req.session.user.role
connector/
├── db.mjs # unified better-sqlite3 connector
docs/
├── S1-T3_Test_Plan.md
tests/
└── api_leases_payments_verify_v2.sh

yaml
Copy code

---

## ⚙️ Implementation Summary

| Area | Update | Status |
|------|---------|--------|
| Database | Added `leases` and `payments` tables with FK constraints to `units` and `users` | ✅ |
| Backend | New routes `/api/leases`, `/api/payments` | ✅ |
| Middleware | `requireRole()` updated to read from `req.session.user` | ✅ |
| DB Connector | Switched to `better-sqlite3` synchronous driver | ✅ |
| Health API | `/api/health` extended to include `leases` and `payments` counts | ✅ |
| Auth | Login + sessions verified via SuperAdmin cookie | ✅ |
| Tests | `api_leases_payments_verify_v2.sh` passes all 9 checks | ✅ |

---

## 🧠 Developer Notes

| Area | Detail |
|------|---------|
| **Pagination** | Controlled by `?page=` and `?per=` in `/api/leases`. |
| **Role-based Access** | Landlords/Admins can write; Tenants read-only. |
| **Schema Alignment** | `rent_cents` and `amount_cents` used (no `property_id` yet). |
| **Health Check** | Extended counts for `properties`, `units`, `leases`, `payments`. |
| **Tests** | Executed via `bash tests/api_leases_payments_verify_v2.sh`. All passed ✅ |

---

## ✅ Definition of Done

| Requirement | Status |
|--------------|--------|
| Lease + Payment tables migrated | ✅ |
| `/api/leases` and `/api/payments` implemented | ✅ |
| Role guards enforced | ✅ |
| `/api/health` includes new entities | ✅ |
| All verification tests pass | ✅ |
| Tagged `S1-T3-complete` | ✅ |

---

## 🧪 Verification Snapshot

bash tests/api_leases_payments_verify_v2.sh
✅ PASSED: 9 ❌ FAILED: 0
All Phase S1-T3 tests passed successfully!

yaml
Copy code

---

## 🔖 Tagging & Deployment

```bash
git add .
git commit -m "S1-T3: Lease & Payment APIs fully verified end-to-end"
git tag -a S1-T3-complete -m "Lease & Payment Integration verified"
git push origin main --tags