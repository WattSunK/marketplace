README.md â€” Phase S1-T3 Developer Notes
# Tenantâ€“Landlord Marketplace â€” Phase S1-T3 Developer Notes
_Date: 09 Oct 2025_

---

## ğŸ¯ Objective
Introduce the **Lease** and **Payment** integration layer that links tenants, units, and landlords.  
Adds `/api/leases` and `/api/payments` endpoints, plus SQL migrations for the new tables.

---

## ğŸ§© Repository Additions


routes/
â”œâ”€â”€ leases.js
â””â”€â”€ payments.js
scripts/sql/
â””â”€â”€ 2025-10-09_create_leases_payments.sql
docs/
â””â”€â”€ S1-T3_Test_Plan.md
tests/
â””â”€â”€ api_leases_payments.sh


---

## âš™ï¸ Installation & Migration

```bash
# Ensure DB is accessible
sqlite3 data/dev/marketplace.dev.db ".tables"

# Apply migration
sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql


Tables expected:

leases
payments
lease_balances (VIEW)

ğŸš€ API Mount Check

Confirm these lines exist in server.js:

import leasesRouter from "./routes/leases.js";
import paymentsRouter from "./routes/payments.js";

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart:

sudo node server.js

ğŸ§ª Smoke Verification
bash tests/api_leases_payments.sh


Expected:

/api/leases â†’ { success:true, data:[...] }

/api/payments â†’ { success:true, data:[...] }

/api/health â†’ includes leases and payments counts.

ğŸ§  Developer Tips
Area	Note
Pagination	Controlled by ?page= and ?per= in /api/leases.
Role-based Access	requireAnyRole(["admin","landlord","tenant"]) used in both routes.
Balance Calculation	Derived from SQL view lease_balances.
Testing	Use separate cookies (admin.jar, landlord.jar, tenant.jar) for role-scoped curl tests.
âœ… Definition of Done
Task	Status
Lease + Payment tables migrated	â˜
/api/leases and /api/payments CRUD implemented	â˜
Role guards enforced	â˜
/api/health includes counts	â˜
All curl tests pass	â˜
Tag commit â†’ S1-T3-complete	â˜

---

### ğŸ§¾ Verification Plan for S1-T3

Once this README and starter pack are deployed:

1. **Run Migration**
   ```bash
   sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql
   sqlite3 data/dev/marketplace.dev.db ".tables"


â†’ confirm leases, payments, and lease_balances.

Mount Routes
In server.js add:

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart Server

sudo node server.js


Smoke Test

bash tests/api_leases_payments.sh


Functional Test

POST /api/leases to create lease

POST /api/payments to add payment

GET /api/leases/:id â†’ should show embedded payments & balance

GET /api/health â†’ should show new entity counts

Tag after success

git add .
git commit -m "S1-T3: Lease & Payment APIs verified"
git tag -a S1-T3-complete -m "Lease & Payment Integration verified"
git push origin main --tags
# Tenantâ€“Landlord Marketplace â€” Phase S1-T3 Developer Notes
_Date: 07 Oct 2025 (Finalized)_

---

## ğŸ¯ Objective
Implement and verify the **Lease & Payment integration layer** that links tenants, units, and landlords.  
Adds `/api/leases` and `/api/payments` endpoints backed by the relational schema with complete role-based access and health monitoring.

---

## ğŸ§© Repository Additions

routes/
â”œâ”€â”€ leases.js
â”œâ”€â”€ payments.js
middleware/
â”œâ”€â”€ requireRole.js # reads req.session.user.role
connector/
â”œâ”€â”€ db.mjs # unified better-sqlite3 connector
docs/
â”œâ”€â”€ S1-T3_Test_Plan.md
tests/
â””â”€â”€ api_leases_payments_verify_v2.sh

yaml
Copy code

---

## âš™ï¸ Implementation Summary

| Area | Update | Status |
|------|---------|--------|
| Database | Added `leases` and `payments` tables with FK constraints to `units` and `users` | âœ… |
| Backend | New routes `/api/leases`, `/api/payments` | âœ… |
| Middleware | `requireRole()` updated to read from `req.session.user` | âœ… |
| DB Connector | Switched to `better-sqlite3` synchronous driver | âœ… |
| Health API | `/api/health` extended to include `leases` and `payments` counts | âœ… |
| Auth | Login + sessions verified via SuperAdmin cookie | âœ… |
| Tests | `api_leases_payments_verify_v2.sh` passes all 9 checks | âœ… |

---

## ğŸ§  Developer Notes

| Area | Detail |
|------|---------|
| **Pagination** | Controlled by `?page=` and `?per=` in `/api/leases`. |
| **Role-based Access** | Landlords/Admins can write; Tenants read-only. |
| **Schema Alignment** | `rent_cents` and `amount_cents` used (no `property_id` yet). |
| **Health Check** | Extended counts for `properties`, `units`, `leases`, `payments`. |
| **Tests** | Executed via `bash tests/api_leases_payments_verify_v2.sh`. All passed âœ… |

---

## âœ… Definition of Done

| Requirement | Status |
|--------------|--------|
| Lease + Payment tables migrated | âœ… |
| `/api/leases` and `/api/payments` implemented | âœ… |
| Role guards enforced | âœ… |
| `/api/health` includes new entities | âœ… |
| All verification tests pass | âœ… |
| Tagged `S1-T3-complete` | âœ… |

---

## ğŸ§ª Verification Snapshot

bash tests/api_leases_payments_verify_v2.sh
âœ… PASSED: 9 âŒ FAILED: 0
All Phase S1-T3 tests passed successfully!

yaml
Copy code

---

## ğŸ”– Tagging & Deployment

```bash
git add .
git commit -m "S1-T3: Lease & Payment APIs fully verified end-to-end"
git tag -a S1-T3-complete -m "Lease & Payment Integration verified"
git push origin main --tags