README.md â€” Phase S1-T3 Developer Notes
# Tenantâ€“Landlord Marketplace â€” Phase S1-T3 Developer Notes
_Date: 09 Oct 2025_

---

## ğŸ¯ Objective
Introduce the **Lease** and **Payment** integration layer that links tenants, units, and landlords.  
Adds `/api/leases` and `/api/payments` endpoints, plus SQL migrations for the new tables.

---

## ğŸ§© Repository Additions


routes/
â”œâ”€â”€ leases.js
â””â”€â”€ payments.js
scripts/sql/
â””â”€â”€ 2025-10-09_create_leases_payments.sql
docs/
â””â”€â”€ S1-T3_Test_Plan.md
tests/
â””â”€â”€ api_leases_payments.sh


---

## âš™ï¸ Installation & Migration

```bash
# Ensure DB is accessible
sqlite3 data/dev/marketplace.dev.db ".tables"

# Apply migration
sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql


Tables expected:

leases
payments
lease_balances (VIEW)

ğŸš€ API Mount Check

Confirm these lines exist in server.js:

import leasesRouter from "./routes/leases.js";
import paymentsRouter from "./routes/payments.js";

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart:

sudo node server.js

ğŸ§ª Smoke Verification
bash tests/api_leases_payments.sh


Expected:

/api/leases â†’ { success:true, data:[...] }

/api/payments â†’ { success:true, data:[...] }

/api/health â†’ includes leases and payments counts.

ğŸ§  Developer Tips
Area	Note
Pagination	Controlled by ?page= and ?per= in /api/leases.
Role-based Access	requireAnyRole(["admin","landlord","tenant"]) used in both routes.
Balance Calculation	Derived from SQL view lease_balances.
Testing	Use separate cookies (admin.jar, landlord.jar, tenant.jar) for role-scoped curl tests.
âœ… Definition of Done
Task	Status
Lease + Payment tables migrated	â˜
/api/leases and /api/payments CRUD implemented	â˜
Role guards enforced	â˜
/api/health includes counts	â˜
All curl tests pass	â˜
Tag commit â†’ S1-T3-complete	â˜

---

### ğŸ§¾ Verification Plan for S1-T3

Once this README and starter pack are deployed:

1. **Run Migration**
   ```bash
   sqlite3 data/dev/marketplace.dev.db < scripts/sql/2025-10-09_create_leases_payments.sql
   sqlite3 data/dev/marketplace.dev.db ".tables"


â†’ confirm leases, payments, and lease_balances.

Mount Routes
In server.js add:

app.use("/api/leases", leasesRouter);
app.use("/api/payments", paymentsRouter);


Restart Server

sudo node server.js


Smoke Test

bash tests/api_leases_payments.sh


Functional Test

POST /api/leases to create lease

POST /api/payments to add payment

GET /api/leases/:id â†’ should show embedded payments & balance

GET /api/health â†’ should show new entity counts

Tag after success

git add .
git commit -m "S1-T3: Lease & Payment APIs verified"
git tag -a S1-T3-complete -m "Lease & Payment Integration verified"
git push origin main --tags
